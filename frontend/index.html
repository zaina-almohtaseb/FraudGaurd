<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fraud Prediction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --deep:#921A40; --mid:#C75B7A; --pale:#D9ABAB; --bg:#F4D9D0; --text:#3a0c1d; }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:flex-start; justify-content:center;
      background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      padding:24px 10px;
    }
    .wrap{width:min(980px,96vw); display:grid; grid-template-columns:1fr 1fr; gap:18px}
    @media (max-width: 860px){ .wrap{grid-template-columns:1fr} }

    .card{ background:var(--mid); padding:26px; border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.12); }
    h1,h2{margin:0 0 14px 0; color:#fff} h1{font-size:24px} h2{font-size:18px}

    label{display:block; color:#fff; margin-top:12px; font-weight:600}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    input,select{
      width:100%; padding:10px 12px; margin-top:6px; border-radius:10px; border:none; outline:none;
      background:rgba(244,217,208,.55); color:var(--text); font-size:14px;
    }
    input:focus,select:focus{box-shadow:0 0 0 2px var(--bg)}
    button{ margin-top:18px; width:100%; padding:12px; border:none; border-radius:10px; cursor:pointer;
            background:var(--deep); color:#fff; font-weight:700; font-size:15px; }
    button.ghost{background:#a33a5b}
    button[disabled]{opacity:.6; cursor:not-allowed}

    .note{font-size:12px; color:#2b2123; margin-top:6px}
    .result{display:none; margin-top:16px; padding:12px; border-radius:10px; background:#fff; color:var(--text); border:1px solid rgba(0,0,0,.06)}
    .error{display:none; margin-top:10px; color:#fff; background:#8c2b3f; padding:8px 10px; border-radius:8px; font-size:13px}

    .admin-panel{background:var(--pale); padding:12px; border-radius:8px; margin-top:16px}
    .admin-panel h3{margin:0 0 6px; color:#600}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- LEFT: Prediction -->
    <section class="card">
      <h1>Fraud Prediction</h1>
      <form id="fraudForm" novalidate>
        <div class="row">
          <div>
            <label>Step (int ≥ 0)
              <input type="number" id="step" min="0" required />
            </label>
          </div>
          <div>
            <label>Amount (≥ 0)
              <input type="number" id="amount" min="0" step="0.01" required />
            </label>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Age band
              <select id="age" required>
                <option value="U">U (Unknown)</option>
                <option>0</option><option>1</option><option>2</option><option>3</option>
                <option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
              </select>
            </label>
          </div>
          <div>
            <label>Gender
              <select id="gender" required>
                <option value="U">U (Unknown)</option>
                <option value="M">M</option>
                <option value="F">F</option>
              </select>
            </label>
          </div>
        </div>

        <label>Category
          <select id="category" required>
            <option value="es_transport">es_transport</option>
            <option value="es_food">es_food</option>
            <option value="es_health">es_health</option>
            <option value="es_fashion">es_fashion</option>
            <option value="es_home">es_home</option>
            <option value="es_entertainment">es_entertainment</option>
            <option value="es_others">es_others</option>
          </select>
        </label>

        <div class="row">
          <div>
            <label>Merchant (optional)
              <input type="text" id="merchant" placeholder="e.g., M12345" />
            </label>
          </div>
          <div>
            <label>Customer ZIP (optional)
              <input type="text" id="zipcodeOri" placeholder="e.g., 28007" />
            </label>
          </div>
        </div>

        <label>Merchant ZIP (optional)
          <input type="text" id="zipMerchant" placeholder="e.g., 28007" />
        </label>

        <div class="row">
          <button id="predictBtn" type="submit">Predict</button>
          <button id="fillBtn" type="button" class="ghost">Fill Test Values</button>
        </div>

        <div id="formError" class="error"></div>
      </form>

      <div id="result" class="result"></div>
      <div id="labelStatus" class="note"></div>
      <div class="note">The result includes a 0/1 prediction and the fraud probability.</div>
    </section>

    <!-- RIGHT: Status + Metrics + Demo -->
    <section class="card" id="rightPanel">
      <h2>Model Status</h2>
      <div class="admin-panel">
        <div id="model-info"><p>Loading model info...</p></div>
      </div>

      <div class="admin-panel">
        <h3>Metrics</h3>
        <div id="metricsContent">Loading…</div>
      </div>

      <div class="admin-panel">
        <h3>Demo Helper</h3>
        <button id="gen10Btn" type="button" class="ghost">Generate 10 labeled rows</button>
        <div id="gen10Msg" class="result" style="background:#fff"></div>
      </div>
    </section>

  </div>

  <script>
    const API_BASE = "http://127.0.0.1:5000";
    const DEMO_ADMIN_TOKEN = "changeme";

    const qs = s => document.querySelector(s);
    const show = (el, html) => { el.style.display='block'; if(html!==undefined) el.innerHTML=html; };
    const hide = el => { el.style.display='none'; el.innerHTML=''; };

    // Prefill from query string (optional)
    (function prefill(){
      const p = new URLSearchParams(location.search);
      const map = {step:'#step',amount:'#amount',age:'#age',gender:'#gender',category:'#category',merchant:'#merchant',zipcodeOri:'#zipcodeOri',zipMerchant:'#zipMerchant'};
      Object.entries(map).forEach(([k,sel]) => p.has(k) && qs(sel) && (qs(sel).value = p.get(k)));
    })();

    // Fill sample inputs
    qs('#fillBtn').addEventListener('click', () => {
      qs('#step').value = 10;
      qs('#amount').value = 15.5;
      qs('#age').value = '3';
      qs('#gender').value = 'M';
      qs('#category').value = 'es_entertainment';
      qs('#merchant').value = 'M12345';
      qs('#zipcodeOri').value = '28007';
      qs('#zipMerchant').value = '28007';
    });

    // Predict handler
    qs('#fraudForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errEl = qs('#formError'); const resEl = qs('#result'); hide(errEl); hide(resEl);

      const step = Number(qs('#step').value), amount = Number(qs('#amount').value);
      if (!Number.isFinite(step) || step < 0 || !Number.isFinite(amount) || amount < 0){
        errEl.textContent = "Please provide valid 'step' (int ≥ 0) and 'amount' (≥ 0)."; return show(errEl);
      }

      const payload = {
        step, amount, age:qs('#age').value, gender:qs('#gender').value, category:qs('#category').value,
        merchant:qs('#merchant').value || undefined, zipcodeOri:qs('#zipcodeOri').value || undefined, zipMerchant:qs('#zipMerchant').value || undefined
      };

      try{
        const r = await fetch(`${API_BASE}/predict`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        const d = await r.json(); if(!r.ok) throw new Error(d.message || JSON.stringify(d.errors) || r.status);
        const prob = (d.fraud_probability*100).toFixed(2), newCount = d.retrain?.new_labeled ?? d.retrain?.new_records ?? 0;
        show(resEl, `
          <div><strong>Fraud Prediction:</strong> ${d.fraud_prediction}</div>
          <div><strong>Fraud Probability:</strong> ${prob}%</div>
          <div class="note">raw_id: ${d.raw_id ?? 'n/a'} | retrain: ${d.retrain?.should_retrain ? 'yes':'no'} | new: ${newCount} / ${d.retrain?.threshold ?? '-'}</div>
          <div class="row" style="margin-top:8px">
            <button type="button" onclick="labelRow(${d.raw_id},1)">Mark Fraud</button>
            <button type="button" class="ghost" onclick="labelRow(${d.raw_id},0)">Mark Not Fraud</button>
          </div>
        `);
        fetchModelInfo(); fetchMetrics();
      }catch(e){ errEl.textContent = 'Error: '+e.message; show(errEl); }
    });

    // Label helper
    async function labelRow(raw_id, fraud){
      const s = qs('#labelStatus'); s.textContent = `Saving label for raw_id ${raw_id}…`;
      try{
        const r = await fetch(`${API_BASE}/label`, {
          method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+DEMO_ADMIN_TOKEN},
          body: JSON.stringify({ id: raw_id, fraud })
        });
        const d = await r.json(); if(!r.ok) throw new Error(d.message || r.status);
        s.textContent = `Saved: id ${d.id} → fraud=${d.fraud}`;
        fetchModelInfo(); fetchMetrics();
      }catch(e){ s.textContent = 'Label failed: '+e.message; }
    }
    window.labelRow = labelRow;

    // Status + metrics
    function fetchModelInfo(){
      fetch(`${API_BASE}/model/info`).then(r=>r.json()).then(d=>{
        qs('#model-info').innerHTML = `
          <p><strong>Model Version:</strong> ${d.model_version ?? 'n/a'}</p>
          <p><strong>Last Retrained:</strong> ${d.last_trained ?? 'n/a'}</p>
          <p><strong>Expected Features:</strong> ${Array.isArray(d.expected_features) ? d.expected_features.join(', ') : 'n/a'}</p>
          <p><strong>Retrain Threshold:</strong> ${d.retrain_threshold ?? '-'}</p>
          <p><strong>New Labeled Rows:</strong> ${d.new_labeled ?? '-'}</p>
          ${d.rows_trained ? `<p><strong>Rows Trained (last):</strong> ${d.rows_trained}</p>` : ''}
          ${d.auc!=null ? `<p><strong>AUC (last):</strong> ${(+d.auc).toFixed(3)}</p>` : ''}
          ${d.train_seconds!=null ? `<p><strong>Train Time:</strong> ${d.train_seconds}s</p>` : ''}
        `;
      }).catch(()=>{ qs('#model-info').innerHTML = `<p style="color:#600">Error loading model info</p>`; });
    }
    function fetchMetrics(){
      fetch(`${API_BASE}/metrics`).then(r=>r.json()).then(m=>{
        qs('#metricsContent').innerHTML = `
          <p><strong>Total Labeled:</strong> ${m.total_labeled ?? '-'}</p>
          <p><strong>Class Balance:</strong> 0=${m.class_0 ?? '-'} / 1=${m.class_1 ?? '-'}</p>
          <p><strong>AUC (sample):</strong> ${m.auc_sample==null ? 'n/a' : (+m.auc_sample).toFixed(3)}</p>
        `;
      }).catch(()=>{ qs('#metricsContent').textContent='Metrics unavailable'; });
    }

    // Demo generator
    qs('#gen10Btn').addEventListener('click', async ()=>{
      const msg = qs('#gen10Msg'); show(msg,'Generating…');
      try{
        for(let i=0;i<10;i++){
          const payload = { amount:+(Math.random()*200+1).toFixed(2), step:i, age:String((i%5)+1), gender:i%2?'M':'F', category:['es_food','es_transport','es_entertainment'][i%3] };
          const pred = await fetch(`${API_BASE}/predict`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(r=>r.json());
          if(!pred.raw_id) throw new Error('predict failed');
          await fetch(`${API_BASE}/label`, {method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+DEMO_ADMIN_TOKEN},body:JSON.stringify({id:pred.raw_id,fraud:i%2})});
          show(msg,`Generated & labeled ${i+1}/10…`);
        }
        show(msg,'Done! Auto-retrain will trigger within ~1 minute.');
        fetchModelInfo(); fetchMetrics();
      }catch(e){ show(msg,'Error: '+e.message); }
    });

    // Kickoff
    fetchModelInfo(); fetchMetrics();
    setInterval(fetchModelInfo, 60000);
    setInterval(fetchMetrics, 60000);
  </script>
</body>
</html>
